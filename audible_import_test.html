<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audible Import Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 10px; border-radius: 4px; cursor: pointer; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        textarea { width: 100%; min-height: 100px; margin: 10px 0; padding: 8px; }
        input { width: 100%; margin: 5px 0; padding: 8px; }
    </style>
</head>
<body>
    <h1>üîß Audible Import Test</h1>
    
    <button onclick="testFullImport()">üîç Vollst√§ndigen Import testen</button>
    
    <div id="results"></div>
    
    <h2>üìù Formulardaten</h2>
    <form id="bookForm">
        <label>Titel:</label>
        <input type="text" name="title">
        
        <label>Autor:</label>
        <input type="text" name="author">
        
        <label>Beschreibung:</label>
        <textarea name="Description"></textarea>
        
        <label>Jahr Published:</label>
        <input type="text" name="Year Published">
        
        <label>Dauer:</label>
        <input type="text" name="duration">
        
        <label>Buchtyp:</label>
        <input type="text" name="bookType">
        
        <label>Bild URL:</label>
        <input type="text" name="image_url">
    </form>
    
    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            results.appendChild(div);
        }
        
        async function testFullImport() {
            log('üöÄ Starte vollst√§ndigen Audible-Import-Test...', 'info');
            
            try {
                // Schritt 1: Audible Suche
                log('üì° Schritt 1: Audible API Suche...', 'info');
                const searchResponse = await fetch('http://localhost:5001/api/audible/search?q=Harry%20Potter&limit=1');
                
                if (!searchResponse.ok) {
                    throw new Error(`API nicht erreichbar: ${searchResponse.status}`);
                }
                
                const searchData = await searchResponse.json();
                if (!searchData.success || !searchData.results.length) {
                    throw new Error('Keine Suchergebnisse erhalten');
                }
                
                const book = searchData.results[0];
                log(`‚úÖ Buch gefunden: "${book.title}"`, 'success');
                
                // Schritt 2: Detail-Fetch (falls n√∂tig)
                let description = book.description || '';
                log(`üìù Beschreibung aus Suche: "${description.substring(0, 50)}..."`, 'info');
                
                if (!description && book.audible_url) {
                    log('üîç Hole Details von Audible-URL...', 'info');
                    try {
                        const detailResponse = await fetch(`http://localhost:5001/api/audible/details?url=${encodeURIComponent(book.audible_url)}`);
                        if (detailResponse.ok) {
                            const detailData = await detailResponse.json();
                            if (detailData.success && detailData.details.description) {
                                description = detailData.details.description;
                                log(`üìù Beschreibung aus Details: "${description.substring(0, 50)}..."`, 'info');
                            }
                        }
                    } catch (error) {
                        log(`‚ö†Ô∏è Detail-Fetch fehlgeschlagen: ${error.message}`, 'error');
                    }
                }
                
                // Schritt 3: Erzeuge volumeInfo (wie im echten Code)
                const volumeInfo = {
                    title: book.title || 'Unbekannter Titel',
                    authors: book.authors || ['Unbekannter Autor'],
                    description: description || 'Keine Beschreibung verf√ºgbar',
                    year_published: book.year_published || '',
                    duration: book.duration || book.runtime || '',
                    booktype: book.booktype || 'Audiobook',
                    image_url: book.image_url || book.cover_url || ''
                };
                
                log('üîÑ VolumeInfo erstellt', 'info');
                
                // Schritt 4: Erzeuge newBook (wie in importExternalBook)
                const newBook = {
                    title: volumeInfo.title || '',
                    author: volumeInfo.authors ? volumeInfo.authors.join(', ') : '',
                    Description: volumeInfo.description || '', // Gro√ügeschrieben!
                    'Year Published': volumeInfo.year_published || '',
                    duration: volumeInfo.duration || '',
                    bookType: volumeInfo.booktype || '',
                    image_url: volumeInfo.image_url || ''
                };
                
                log('üì¶ newBook-Objekt erstellt', 'info');
                log(`üìù Beschreibung im newBook: "${newBook.Description}"`, 'info');
                
                // Schritt 5: Bef√ºlle Formular (wie in fillFormWithBookData)
                log('üìù Bef√ºlle Formular...', 'info');
                const form = document.getElementById('bookForm');
                form.reset();
                
                let fieldsSet = 0;
                let descriptionSet = false;
                
                Object.keys(newBook).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) {
                        if (input.type === 'checkbox') {
                            input.checked = newBook[key] === true;
                        } else {
                            input.value = newBook[key] || '';
                        }
                        fieldsSet++;
                        
                        if (key === 'Description') {
                            descriptionSet = true;
                            log(`‚úÖ Beschreibungsfeld gesetzt: "${newBook[key]}"`, 'success');
                        } else {
                            log(`‚úÖ Feld "${key}" gesetzt: "${newBook[key]}"`, 'success');
                        }
                    } else {
                        log(`‚ö†Ô∏è Feld "${key}" nicht gefunden im Formular`, 'error');
                    }
                });
                
                // Finale √úberpr√ºfung
                const descField = form.querySelector('[name="Description"]');
                if (descField && descField.value) {
                    log(`üéâ SUCCESS! Beschreibungsfeld wurde erfolgreich bef√ºllt!`, 'success');
                    log(`üìù Inhalt: "${descField.value}"`, 'success');
                } else {
                    log(`‚ùå FEHLER! Beschreibungsfeld ist leer!`, 'error');
                }
                
                log(`üìä Zusammenfassung: ${fieldsSet} Felder bef√ºllt, Beschreibung: ${descriptionSet ? 'JA' : 'NEIN'}`, fieldsSet > 0 ? 'success' : 'error');
                
            } catch (error) {
                log(`‚ùå Test fehlgeschlagen: ${error.message}`, 'error');
            }
        }
        
        // Auto-Test beim Laden
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Audible Import Test bereit', 'info');
        });
    </script>
</body>
</html>
